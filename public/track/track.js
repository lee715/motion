// Generated by CoffeeScript 1.6.3
(function() {
  define(['../graphic/factory', './mix', '../array/slice', '../array/str2arr', '../filter/filter', '../filter/add', '../function/copyWithContext', '../promise/type', '../event'], function(F, Mix, slice, str2arr, filter, add, copy, type, Event) {
    var Track, track;
    Track = (function() {
      function Track(gpc, opts) {
        var bl, fil;
        this.opts = opts = opts || {};
        this.gpc = gpc;
        this.timeCosted = opts.delay && opts.delay * 1000 || 0;
        this.status = 'initialize';
        this.t = opts.t || Infinity;
        this.baseline = bl = opts.baseline || gpc.getS(this.t);
        this.end = opts.end || 'stop';
        if (!(fil = opts.filter)) {
          fil = [[], []];
        }
        fil[0] = str2arr(fil[0]);
        fil[0].push('beforeEnd');
        fil[1].push(function() {
          var i, k, _i, _len;
          for (i = _i = 0, _len = this.length; _i < _len; i = ++_i) {
            k = this[i];
            this[i] /= bl;
          }
          return this;
        });
        this.filter = filter.apply(null, fil);
        this.filter.beforeEnd(1);
        opts.autoStart && this.start();
      }

      Track.prototype.reverse = false;

      Track.prototype.promise = function() {
        var res;
        res = {};
        copy(res, this, 'stop restart start repeat on');
        copy(res, this.filter);
        return res;
      };

      Track.prototype.start = function() {
        var m,
          _this = this;
        this.status = 'moving';
        return m = setInterval(function() {
          var now, val;
          if (_this.status === 'stop') {
            return clearInterval(m);
          }
          _this.timeCosted += 20;
          if (_this.reverse) {
            now = _this.t - _this.timeCosted / 1000;
          } else {
            now = _this.timeCosted / 1000;
          }
          val = _this.gpc.getS(now);
          val = _this.filter.filter([val])[0];
          _this.trigger('progress', val);
          if (_this.timeCosted >= _this.t * 1000) {
            return _this.onEnd(m);
          }
        }, 20);
      };

      Track.prototype.stop = function() {
        if (this.status === 'moving') {
          return this.status = 'stop';
        }
      };

      Track.prototype.restart = function() {
        if (this.status === 'stop' || 'initialize') {
          this.status = 'moving';
          return this.start();
        }
      };

      Track.prototype.repeat = function() {
        if (this.status === 'end') {
          this.status = 'moving';
          this.timeCosted = 0;
          return this.start();
        }
      };

      Track.prototype.onEnd = function(timer) {
        var p, st, vt;
        switch (this.end) {
          case 'stop':
            clearInterval(timer);
            this.status = 'end';
            return this.trigger('done');
          case 'stay':
            vt = this.gpc.getY(this.t);
            st = this.gpc.getS(this.t);
            this.gpc = F.get('line', 0, vt);
            if (!this.filter.add) {
              this.filter.register('add', add);
            }
            this.filter.add(st);
            this.timeCosted = 0;
            return this.trigger('stay');
          case 'repeat':
            this.timeCosted = 0;
            return this.trigger('repeat');
          case 'decay-t':
            p = this.opts['decay-t'] || 0.8;
            this.t *= 0.8;
            this.timeCosted = 0;
            return this.trigger('decay');
          case 'reverse':
            this.reverse = !this.reverse;
            this.timeCosted = 0;
            return this.trigger('reverse');
        }
      };

      return Track;

    })();
    $.extend(Track.prototype, Event);
    return track = {
      get: function(track, opts) {
        var ctl, gpc;
        track = str2arr(track);
        gpc = this.getGpc.apply(this, track);
        ctl = new Track(gpc, opts);
        return ctl;
      },
      getGpc: function(name) {
        var args, gpc;
        args = slice.call(arguments);
        if (type('array', args[0])) {
          if (args.length === 1) {
            args = args[0];
          } else {
            return;
          }
        }
        if (type('string', args[0])) {
          if (!(gpc = Mix.get.apply(Mix, args))) {
            gpc = F.get.apply(F, args);
          }
        }
        return gpc;
      }
    };
  });

}).call(this);
